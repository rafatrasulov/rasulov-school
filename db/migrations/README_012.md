# Migration 012: Fix Teacher RLS Policies

## Проблемы, которые исправляет эта миграция

### ❌ Проблема 1: Пустой список учеников в админке
**Симптом:** Раздел "Ученики" в админ-панели показывает "0 учеников", даже если студенты зарегистрированы в базе данных.

**Причина:** Отсутствует политика RLS, позволяющая учителям читать профили студентов из таблицы `profiles`.

**Решение:** Добавлена политика `"Teachers can read student profiles"`, позволяющая учителям видеть профили всех студентов.

---

### ❌ Проблема 2: Невозможно выставить оценку
**Симптом:** Учитель видит ответы студентов на задания, но при попытке выставить оценку или добавить комментарий появляется ошибка, и данные не сохраняются.

**Причина:** Отсутствует политика RLS для UPDATE таблицы `assignment_submissions` для учителей. Существующая политика `assignment_submissions_update_own` разрешает обновление только самому студенту.

**Решение:** Добавлена политика `"Teachers can update student submissions"`, позволяющая учителям обновлять оценки и комментарии к ответам студентов.

---

## Как применить миграцию

### Вариант 1: Через Supabase Dashboard (рекомендуется)
1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Скопируйте содержимое файла `012_fix_teacher_rls_policies.sql`
4. Вставьте в редактор и нажмите "Run"

### Вариант 2: Через командную строку
```bash
# Если у вас настроен Supabase CLI
supabase db push
```

---

## Проверка работы миграции

После применения миграции выполните следующие проверки **от имени учителя**:

### 1. Проверка списка студентов
```sql
SELECT id, full_name, email, grade, created_at 
FROM profiles 
WHERE role = 'student'
ORDER BY created_at DESC;
```
**Ожидаемый результат:** Должны отобразиться все зарегистрированные студенты.

### 2. Проверка доступа к ответам
```sql
SELECT * FROM assignment_submissions LIMIT 5;
```
**Ожидаемый результат:** Должны отобразиться ответы студентов на задания.

### 3. Проверка возможности обновления оценки
```sql
-- Замените <submission_id> на реальный ID из предыдущего запроса
UPDATE assignment_submissions 
SET score = 100, teacher_feedback = 'Отлично!' 
WHERE id = '<submission_id>';
```
**Ожидаемый результат:** Запрос должен выполниться успешно без ошибок.

---

## Проверка через UI

### В админ-панели учителя:

1. **Список учеников** (`/admin/students`):
   - ✅ Должно отображаться количество зарегистрированных учеников
   - ✅ Должна быть таблица со всеми студентами

2. **Профиль студента** (`/admin/students/[id]`):
   - ✅ Должна отображаться информация о студенте
   - ✅ Должна быть статистика (всего заданий, средний балл)
   - ✅ Должна быть история бронирований
   - ✅ Должен быть список выполненных заданий

3. **Оценивание заданий** (`/admin/assignments/[id]`):
   - ✅ Должны отображаться ответы студентов
   - ✅ Кнопка "Оценить" должна работать
   - ✅ Оценка и комментарий должны сохраняться
   - ✅ Студент должен видеть оценку и комментарий в своем личном кабинете

---

## Технические детали

### Добавленные политики:

#### 1. Teachers can read student profiles
```sql
CREATE POLICY "Teachers can read student profiles" ON profiles
  FOR SELECT USING (
    role = 'student' 
    AND EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role = 'teacher'
    )
  );
```

**Логика:**
- Применяется к строкам с `role = 'student'`
- Проверяет, что текущий пользователь (`auth.uid()`) является учителем
- Позволяет читать профили всех студентов

#### 2. Teachers can update student submissions
```sql
CREATE POLICY "Teachers can update student submissions" ON assignment_submissions
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE profiles.id = auth.uid() 
      AND profiles.role = 'teacher'
    )
  );
```

**Логика:**
- Проверяет, что текущий пользователь является учителем
- Позволяет обновлять любые записи в `assignment_submissions`
- Используется для выставления оценок и комментариев

---

## Безопасность

Обе политики безопасны, так как:
- ✅ Проверяют роль пользователя через подзапрос к таблице `profiles`
- ✅ Используют `auth.uid()` для идентификации текущего пользователя
- ✅ Не позволяют студентам получить доступ к данным других студентов
- ✅ Не позволяют неавторизованным пользователям получить доступ

---

## Откат миграции (если необходимо)

Если нужно откатить изменения:

```sql
-- Удалить добавленные политики
DROP POLICY IF EXISTS "Teachers can read student profiles" ON profiles;
DROP POLICY IF EXISTS "Teachers can update student submissions" ON assignment_submissions;
```

**⚠️ Внимание:** После отката учителя снова не смогут видеть студентов и выставлять оценки!
