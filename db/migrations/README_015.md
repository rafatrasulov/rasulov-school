# Миграция 015: политика чтения своего профиля

## Проблема

- При входе учителя через форму ученика (`/login`) его пускает в кабинет ученика.
- Запрос в приложении `SELECT role FROM profiles WHERE id = auth.uid()` возвращает пустой результат из‑за RLS.
- В SQL Editor запрос `SELECT ... FROM profiles WHERE id = auth.uid()` тоже даёт 0 строк — **это нормально**: в редакторе запрос выполняется не от имени пользователя приложения, поэтому `auth.uid()` там `NULL`.

## Решение

Применить миграцию **015_profiles_select_own_force.sql** в Supabase SQL Editor. Она создаёт политику `profiles_select_own`, разрешающую чтение своей строки в `profiles` по условию `auth.uid() = id`.

## Как применить

1. Откройте Supabase → SQL Editor.
2. Вставьте содержимое файла `015_profiles_select_own_force.sql`.
3. Выполните запрос (Run).

## Проверка в SQL Editor (только что политика есть)

```sql
SELECT policyname, cmd
FROM pg_policies
WHERE tablename = 'profiles' AND cmd = 'SELECT';
```

Должны быть среди прочего: `profiles_select_own`, политики для учителей и публичного чтения.

## Проверка в браузере (реальный тест)

1. Выйти из аккаунта на сайте.
2. Открыть `/login` и войти **учеткой учителя**.
3. Должно показать ошибку: «Для входа учителя используйте кнопку «Вход для учителя»» и не пускать в кабинет ученика.
4. Открыть `/admin/login` и войти той же учеткой учителя — вход в админку должен проходить, фото учителя в шапке должно отображаться.

## Про «Users can update own profile» для SELECT

Политика `profiles_update_own` относится к **UPDATE**, не к SELECT. Если в списке политик она отображается рядом с SELECT, возможна путаница в интерфейсе или несколько политик с похожими именами. Для входа важен именно **SELECT** своей строки — его обеспечивает `profiles_select_own` после применения 015.
